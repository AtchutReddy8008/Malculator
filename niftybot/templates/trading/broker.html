{% extends 'base.html' %}

{% block title %}Broker Connection - Trade with Naman{% endblock %}

{% block extra_css %}
<style>
    /* Readability Fix: White button text + refined contrasts */
    :root {
        --primary: #22d3ee;         /* Cyan accent */
        --success: #10b981;         /* Teal-green */
        --danger: #ef4444;
        --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b 60%, #334155);
        --card-bg: rgba(30, 41, 59, 0.85);
        --card-border: rgba(203, 213, 225, 0.12);
        --text-main: #f1f5f9;
        --text-muted: #cbd5e1;
        --text-label: #94a3b8;
        --glow-success: rgba(16, 185, 129, 0.45);
        --btn-text: #ffffff;        /* Pure white for button text */
    }

    .broker-section {
        background: var(--bg-gradient);
        border-radius: 20px;
        padding: 2.5rem 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--card-border);
    }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        transition: all 0.45s cubic-bezier(0.165, 0.84, 0.44, 1);
        opacity: 0;
        transform: translateY(20px);
        animation: cardFadeIn 0.9s ease-out forwards;
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 60px rgba(34, 211, 238, 0.18);
    }

    @keyframes cardFadeIn {
        to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
        background: linear-gradient(135deg, #1e293b, #334155);
        border-bottom: none;
        padding: 1.25rem 1.5rem;
        color: #f1f5f9;
        font-weight: 600;
    }

    .form-floating > .form-control,
    .form-floating > .form-control-plaintext {
        background: rgba(51, 65, 85, 0.7);
        border: 1px solid rgba(203, 213, 225, 0.25);
        color: var(--text-main);
        border-radius: 12px;
        padding: 1rem 1rem 0.5rem;
        height: calc(3.5rem + 2px);
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .form-floating > .form-control:focus,
    .form-floating > .form-control:not(:placeholder-shown) {
        background: rgba(51, 65, 85, 0.9);
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(34, 211, 238, 0.2);
    }

    .form-floating > label {
        color: var(--text-label);
        padding: 1rem 1rem;
        transition: all 0.3s ease;
    }

    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        color: var(--primary);
        transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    }

    .form-floating .toggle-btn {
        position: absolute;
        top: 50%;
        right: 1rem;
        transform: translateY(-50%);
        z-index: 5;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 1.1rem;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .form-floating .toggle-btn:hover {
        color: var(--primary);
    }

    .form-control::placeholder {
        color: rgba(203, 213, 225, 0.55);
    }

    .status-connected {
        background: rgba(16, 185, 129, 0.18);
        color: var(--success);
        padding: 0.45rem 1.1rem;
        border-radius: 50px;
        font-weight: 600;
        border: 1px solid rgba(16, 185, 129, 0.45);
        box-shadow: 0 0 18px var(--glow-success);
        animation: softPulse 2.8s infinite alternate;
    }

    .status-disconnected {
        background: rgba(239, 68, 68, 0.18);
        color: var(--danger);
        padding: 0.45rem 1.1rem;
        border-radius: 50px;
        font-weight: 600;
        border: 1px solid rgba(239, 68, 68, 0.45);
    }

    @keyframes softPulse {
        from { box-shadow: 0 0 12px var(--glow-success); }
        to   { box-shadow: 0 0 26px var(--glow-success); }
    }

    .btn-primary {
        background: linear-gradient(135deg, #06b6d4, #0891b2); /* Slightly brighter stops */
        border: none;
        font-weight: 600;
        padding: 0.8rem 1.6rem;
        border-radius: 12px;
        transition: all 0.4s ease;
        color: var(--btn-text); /* White text for perfect visibility */
        text-shadow: 0 1px 2px rgba(0,0,0,0.4); /* Subtle shadow for depth/readability */
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 32px rgba(34, 211, 238, 0.4);
    }

    /* ──────────────────────────────────────────────── */
    /* Added: Make How-to list text clearly visible     */
    .how-to-list {
        color: #ffffff !important;
        font-weight: 500;
    }

    .how-to-list li {
        margin-bottom: 0.9rem;
    }

    .how-to-list li::before {
        color: var(--primary) !important;
        font-weight: 700;
    }

    .how-to-list a {
        color: #67e8f9 !important;          /* Bright cyan - visible & theme-matched */
        text-decoration: underline;
        transition: color 0.2s ease;
    }

    .how-to-list a:hover {
        color: #a5f3fc !important;
    }
    /* ──────────────────────────────────────────────── */

    .alert-warning {
        background: rgba(249, 115, 22, 0.15);
        border-left: 4px solid #f97316;
        border-radius: 10px;
        color: #fed7aa;
    }

    .text-muted {
        color: var(--text-muted) !important;
    }

    .table-hover tbody tr:hover {
        background: rgba(34, 211, 238, 0.08);
    }
</style>
{% endblock %}

{% block content %}
<div class="broker-section">
    <div class="row">
        <div class="col-md-12 text-center">
            <h1 class="mb-4"><i class="fas fa-plug me-3" style="color:var(--primary)"></i> Broker Connection</h1>
            <p class="text-muted lead">Securely connect Zerodha to power automated NIFTY trading</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i> Connect Zerodha Account</h5>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info border-0 bg-info bg-opacity-10 text-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Your credentials are stored securely in our database. They are only used to authenticate with Zerodha's API.
                    </div>

                    <form method="post" class="mt-4">
                        {% csrf_token %}

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-floating position-relative">
                                    {{ form.api_key }}
                                    <label for="{{ form.api_key.id_for_label }}">API Key *</label>
                                </div>
                                {% if form.api_key.errors %}
                                    <div class="text-danger mt-1 small">{{ form.api_key.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating position-relative">
                                    {{ form.secret_key }}
                                    <label for="{{ form.secret_key.id_for_label }}">Secret Key *</label>
                                    <button type="button" class="toggle-btn toggle-secret">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                {% if form.secret_key.errors %}
                                    <div class="text-danger mt-1 small">{{ form.secret_key.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.zerodha_user_id }}
                                    <label for="{{ form.zerodha_user_id.id_for_label }}">Zerodha User ID *</label>
                                </div>
                                {% if form.zerodha_user_id.errors %}
                                    <div class="text-danger mt-1 small">{{ form.zerodha_user_id.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating position-relative">
                                    {{ form.password }}
                                    <label for="{{ form.password.id_for_label }}">Password *</label>
                                    <button type="button" class="toggle-btn toggle-password">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                {% if form.password.errors %}
                                    <div class="text-danger mt-1 small">{{ form.password.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    {{ form.totp }}
                                    <label for="{{ form.totp.id_for_label }}">TOTP Secret (Optional)</label>
                                </div>
                                <small class="text-muted d-block mt-1">Required for automated trading. Get this from Zerodha Console → Profile → Two Factor Authentication → TOTP</small>
                                {% if form.totp.errors %}
                                    <div class="text-danger mt-1 small">{{ form.totp.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i> Save Credentials
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i> How to Get Credentials</h5>
                </div>
                <div class="card-body">
                    <ol class="how-to-list list-unstyled mb-0">
                        <li>Go to <a href="https://kite.zerodha.com" target="_blank" class="text-info">Zerodha Kite</a></li>
                        <li>Login to your account</li>
                        <li>Go to <strong>Developer Console</strong></li>
                        <li>Create a new app or use existing one</li>
                        <li>Copy the API Key and Secret Key</li>
                        <li>Your Zerodha User ID and Password are your login credentials</li>
                        <li>For TOTP Secret: Profile → Two Factor Authentication → TOTP</li>
                    </ol>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i> Security Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <strong>Broker Connection:</strong>
                        {% if has_credentials %}
                            <span class="status-connected"><i class="fas fa-check-circle me-2"></i> CONNECTED</span>
                        {% else %}
                            <span class="status-disconnected"><i class="fas fa-times-circle me-2"></i> NOT CONNECTED</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>Last Updated:</strong><br>
                        {% if brokers.first %}
                            {{ brokers.first.updated_at|date:"Y-m-d H:i" }}
                        {% else %}
                            Never
                        {% endif %}
                    </div>

                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Security Tips:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Never share your credentials</li>
                            <li>Use strong passwords</li>
                            <li>Enable 2FA on Zerodha</li>
                            <li>Monitor account regularly</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i> Connection History</h5>
                </div>
                <div class="card-body p-0">
                    {% if brokers %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 text-center align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Broker</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for broker in brokers %}
                                        <tr>
                                            <td>{{ broker.broker_name }}</td>
                                            <td>
                                                {% if broker.is_active %}
                                                    <span class="badge bg-success px-3 py-2">Active</span>
                                                {% else %}
                                                    <span class="badge bg-danger px-3 py-2">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ broker.created_at|date:"Y-m-d H:i" }}</td>
                                            <td>{{ broker.updated_at|date:"Y-m-d H:i" }}</td>
                                            <td>
                                                <a href="#" class="btn btn-sm btn-outline-light"><i class="fas fa-edit"></i> Edit</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                            <p>No broker connections found yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle password visibility
        const togglePassword = document.querySelector('.toggle-password');
        const passwordField = document.getElementById('id_password');

        if (togglePassword && passwordField) {
            togglePassword.addEventListener('click', function () {
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        // Toggle secret key visibility
        const toggleSecret = document.querySelector('.toggle-secret');
        const secretField = document.getElementById('id_secret_key');

        if (toggleSecret && secretField) {
            toggleSecret.addEventListener('click', function () {
                const type = secretField.getAttribute('type') === 'password' ? 'text' : 'password';
                secretField.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        // Ensure initial type
        if (passwordField) passwordField.type = 'password';
        if (secretField) secretField.type = 'password';
    });
</script>
{% endblock %}